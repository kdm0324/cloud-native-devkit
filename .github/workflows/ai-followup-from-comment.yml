name: AI PR Follow-up from Comment (Gemini)

on:
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "대상 PR 번호"
        required: true
        type: string
      instruction:
        description: "PR에 남길 /ai 지시사항(코멘트 본문 대신 사용)"
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: ai-pr-followup
  cancel-in-progress: false

jobs:
  followup:
    # PR 코멘트이고 /ai 로 시작하며, 작성자가 kdm0324일 때만 자동 실행
    if: >
      (
        github.event_name == 'issue_comment' &&
        github.event.issue.pull_request &&
        startsWith(github.event.comment.body, '/ai') &&
        github.actor == 'kdm0324'
      )
      ||
      (
        github.event_name == 'workflow_dispatch'
      )
    runs-on: ubuntu-latest

    steps:
      - name: Resolve PR number & instruction
        id: ctx
        run: |
          set -euo pipefail

          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            echo "pr_number=${{ github.event.issue.number }}" >> "$GITHUB_OUTPUT"
            echo "instruction<<EOF" >> "$GITHUB_OUTPUT"
            echo "${{ github.event.comment.body }}" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
            echo "trigger=issue_comment" >> "$GITHUB_OUTPUT"
          else
            echo "pr_number=${{ inputs.pr_number }}" >> "$GITHUB_OUTPUT"
            echo "instruction<<EOF" >> "$GITHUB_OUTPUT"
            echo "${{ inputs.instruction }}" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
            echo "trigger=workflow_dispatch" >> "$GITHUB_OUTPUT"
          fi

      - name: Fetch PR metadata
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          PR_NUMBER="${{ steps.ctx.outputs.pr_number }}"
          gh pr view "$PR_NUMBER" --json headRefName,headRepository,baseRepository,url,title,body \
            > pr.json

          echo "PR_NUMBER=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          echo "HEAD_REF=$(jq -r '.headRefName' pr.json)" >> "$GITHUB_OUTPUT"
          echo "HEAD_REPO=$(jq -r '.headRepository.nameWithOwner' pr.json)" >> "$GITHUB_OUTPUT"
          echo "BASE_REPO=$(jq -r '.baseRepository.nameWithOwner' pr.json)" >> "$GITHUB_OUTPUT"
          echo "PR_URL=$(jq -r '.url' pr.json)" >> "$GITHUB_OUTPUT"
          echo "PR_TITLE<<EOF" >> "$GITHUB_OUTPUT"
          jq -r '.title' pr.json >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Safety gate (same repo + ai/* branch only)
        run: |
          set -euo pipefail

          if [ "${{ steps.pr.outputs.HEAD_REPO }}" != "${{ steps.pr.outputs.BASE_REPO }}" ]; then
            echo "Blocked: PR from a fork."
            exit 1
          fi

          case "${{ steps.pr.outputs.HEAD_REF }}" in
            ai/*) echo "OK: ai branch" ;;
            *) echo "Blocked: not an ai/* branch"; exit 1 ;;
          esac

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr.outputs.HEAD_REF }}
          fetch-depth: 0

      - name: Prevent committing Gemini artifacts (local exclude)
        run: |
          set -euo pipefail
          {
            echo ".gemini/"
            echo "ISSUE_BODY.txt"
            echo "*.gemini*"
          } >> .git/info/exclude

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps & build core (baseline)
        run: |
          set -euo pipefail
          npm ci
          npm --workspace packages/core run build

      - name: Install Gemini CLI
        run: |
          set -euo pipefail
          npm i -g @google/gemini-cli

      - name: Agent (Gemini follow-up edits repo in VM)
        id: gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          set -euo pipefail

          PR_NUMBER="${{ steps.pr.outputs.PR_NUMBER }}"
          PR_TITLE="${{ steps.pr.outputs.PR_TITLE }}"
          INSTRUCTION="${{ steps.ctx.outputs.instruction }}"

          PROMPT_FILE="${RUNNER_TEMP}/PROMPT.txt"

          cat > "$PROMPT_FILE" <<EOF
          You are an autonomous coding agent working inside a GitHub Actions runner.
          
          Repository: cloud-native-devkit
          You are checked out on an existing AI-generated PR branch:
          - PR: #${PR_NUMBER}
          - Branch: ${{ steps.pr.outputs.HEAD_REF }}
          - Title: ${PR_TITLE}
          
          User instruction (from PR comment or manual dispatch):
          ${INSTRUCTION}
          
          Rules (MUST follow):
          1) Apply ONLY what the instruction requests. Keep diff minimal and safe.
          2) Prefer editing existing files; do NOT create new config/command files (especially under .gemini/).
          3) Do NOT print secrets or environment variables.
          4) Do NOT run install/build/test commands yourself (npm/yarn/pnpm/make/gradle/mvn etc). The workflow will run verification after you finish.
          5) If the instruction asks for docs-only, change docs only.
          
          Now modify the repository files accordingly.
          EOF

          attempts=0
          max_attempts=3
          while true; do
            attempts=$((attempts+1))
            echo "Gemini attempt ${attempts}/${max_attempts}"

            set +e
            gemini --yolo "$(cat "$PROMPT_FILE")" 2> "${RUNNER_TEMP}/gemini_stderr.txt"
            rc=$?
            set -e

            if [ $rc -eq 0 ]; then
              echo "Gemini completed."
              break
            fi

            if [ $attempts -ge $max_attempts ]; then
              echo "Gemini failed after retries."
              cat "${RUNNER_TEMP}/gemini_stderr.txt" || true
              exit 1
            fi

            sleep $((attempts * 10))
          done

          rm -rf .gemini || true

      - name: Verify (runbook)
        id: verify
        run: |
          set -euo pipefail
          npm ci
          npm --workspace packages/core run build
          npm run dev:cli -- doctor

      - name: Commit & push (if changes exist)
        id: push
        run: |
          set -euo pipefail

          rm -rf .gemini || true

          if git diff --quiet && git diff --cached --quiet; then
            echo "No changes to commit."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git config user.name "ai-bot"
          git config user.email "ai-bot@users.noreply.github.com"

          git add -A -- ':!.gemini' ':!ISSUE_BODY.txt'

          if git diff --cached --quiet; then
            echo "No staged changes."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git commit -m "ai: follow-up from PR comment"
          git push

          echo "changed=true" >> "$GITHUB_OUTPUT"

      - name: Comment back to PR (success)
        if: steps.push.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          gh pr comment "${{ steps.pr.outputs.PR_NUMBER }}" --body \
            "✅ Applied your /ai feedback and pushed commits to \`${{ steps.pr.outputs.HEAD_REF }}\`."

      - name: Comment back to PR (no-op)
        if: steps.push.outputs.changed != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          gh pr comment "${{ steps.pr.outputs.PR_NUMBER }}" --body \
            "ℹ️ No code/doc changes detected from your /ai instruction, so nothing was committed."

      - name: Comment back to PR (failure)
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          PR_NUMBER="${{ steps.pr.outputs.PR_NUMBER }}"

          if [ -f "${RUNNER_TEMP}/gemini_stderr.txt" ]; then
            ERR="$(tail -n 30 "${RUNNER_TEMP}/gemini_stderr.txt" | sed 's/`/\\`/g')"
          else
            ERR="(no gemini stderr captured)"
          fi

          gh pr comment "$PR_NUMBER" --body \
            "❌ Follow-up failed. I did not push any commits.
            
            Last Gemini error (tail):
            \`\`\`
            $ERR
            \`\`\`
            
            Next steps:
            - Check Actions log for this run
            - If it was quota/rate-limit, retry later or switch API key/plan"
