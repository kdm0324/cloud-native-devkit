name: AI PR Follow-up from Comment (Gemini)

on:
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "ëŒ€ìƒ PR ë²ˆí˜¸"
        required: true
        type: string
      instruction:
        description: "ì—ì´ì „íŠ¸ì—ê²Œ ì‹œí‚¬ ì‘ì—… ì§€ì‹œ(/ai ì—†ì´ ë³¸ë¬¸ë§Œ ì…ë ¥)"
        required: true
        type: string
      dry_run:
        description: "trueë©´ ì»¤ë°‹/í‘¸ì‹œ ì—†ì´ ìˆ˜ì •+ê²€ì¦ê¹Œì§€ë§Œ"
        required: false
        default: "false"
        type: choice
        options: ["false", "true"]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: ai-pr-followup-${{ github.event.issue.number || inputs.pr_number }}
  cancel-in-progress: true

jobs:
  followup:
    if: >
      (
        github.event_name == 'issue_comment' &&
        github.event.issue.pull_request &&
        startsWith(github.event.comment.body, '/ai') &&
        github.actor == 'kdm0324'
      )
      ||
      (github.event_name == 'workflow_dispatch')

    runs-on: ubuntu-latest

    steps:
      - name: Resolve PR number & instruction
        id: ctx
        run: |
          set -euo pipefail

          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            PR_NUMBER="${{ github.event.issue.number }}"
            RAW="${{ github.event.comment.body }}"
            # '/ai' ì ‘ë‘ ì œê±° + ì• ê³µë°± ì œê±°
            INSTRUCTION="${RAW#/ai}"
            INSTRUCTION="${INSTRUCTION#"${INSTRUCTION%%[![:space:]]*}"}"
            DRY_RUN="false"
          else
            PR_NUMBER="${{ inputs.pr_number }}"
            INSTRUCTION="${{ inputs.instruction }}"
            DRY_RUN="${{ inputs.dry_run }}"
          fi

          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          {
            echo "instruction<<EOF"
            echo "$INSTRUCTION"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
          echo "dry_run=$DRY_RUN" >> "$GITHUB_OUTPUT"

      - name: Fetch PR metadata
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          PR_NUMBER="${{ steps.ctx.outputs.pr_number }}"

          gh pr view "$PR_NUMBER" --json number,url,headRefName,headRepository,isCrossRepository > pr.json

          echo "PR_NUMBER=$(jq -r '.number' pr.json)" >> "$GITHUB_OUTPUT"
          echo "PR_URL=$(jq -r '.url' pr.json)" >> "$GITHUB_OUTPUT"
          echo "HEAD_REF=$(jq -r '.headRefName' pr.json)" >> "$GITHUB_OUTPUT"
          echo "IS_CROSS_REPO=$(jq -r '.isCrossRepository' pr.json)" >> "$GITHUB_OUTPUT"
          echo "HEAD_REPO=$(jq -r '.headRepository.nameWithOwner' pr.json)" >> "$GITHUB_OUTPUT"

      - name: Safety gate (same repo + ai/* branch only)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          if [ "${{ steps.pr.outputs.IS_CROSS_REPO }}" = "true" ]; then
            echo "Blocked: PR from fork (isCrossRepository=true)"
            exit 1
          fi

          if [ "${{ steps.pr.outputs.HEAD_REPO }}" != "${GITHUB_REPOSITORY}" ]; then
            echo "Blocked: head repo mismatch (${{
              steps.pr.outputs.HEAD_REPO
            }} != ${GITHUB_REPOSITORY})"
            exit 1
          fi

          case "${{ steps.pr.outputs.HEAD_REF }}" in
            ai/*) echo "OK: ai branch" ;;
            *) echo "Blocked: not an ai/* branch"; exit 1 ;;
          esac

      - name: Checkout repo (base) + fetch PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout PR branch
        run: |
          set -euo pipefail
          HEAD_REF="${{ steps.pr.outputs.HEAD_REF }}"
          git fetch origin "$HEAD_REF":"$HEAD_REF"
          git checkout "$HEAD_REF"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps & build core (baseline)
        run: |
          set -euo pipefail
          npm ci
          npm --workspace packages/core run build

      # ----------------------------
      # Agent (Gemini)
      # - ì—ì´ì „íŠ¸ëŠ” íŒŒì¼ ìˆ˜ì •ë§Œ
      # - npm ë“± ê²€ì¦ ì»¤ë§¨ë“œëŠ” ì•„ë˜ Verify ë‹¨ê³„ì—ì„œ VMì´ ì‹¤í–‰
      # ----------------------------
      - name: Agent (Gemini)
        uses: google-github-actions/run-gemini-cli@v0
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          args: >-
            You are an autonomous coding agent working on the repository cloud-native-devkit.
            You are continuing work on an existing PR branch.

            USER INSTRUCTION (from PR comment or manual dispatch):
            ${{ steps.ctx.outputs.instruction }}

            REQUIRED BEHAVIOR:
            1) Internally convert the instruction into a TOON plan (Task/Outcome/Ops/Notes). Do NOT ask questions.
            2) Apply ONLY what is requested. Keep changes minimal and safe.
            3) Do NOT run any install/build/test commands (npm/yarn/pnpm/make/gradle/mvn/etc).
            4) Do NOT run any shell commands at all.
            5) Do not print secrets or environment variables.
            IMPLEMENT NOW by editing repository files only.

      - name: Verify (runbook)
        run: |
          set -euo pipefail
          npm ci
          npm --workspace packages/core run build
          npm run dev:cli -- doctor

      - name: On verification failure, comment and stop
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          gh pr comment "${{ steps.pr.outputs.PR_NUMBER }}" --body \
            "âŒ ê²€ì¦ ì‹¤íŒ¨ë¡œ ì¤‘ë‹¨í–ˆìŠµë‹ˆë‹¤.

          - ì‹¤í–‰í•œ ì»¤ë§¨ë“œ:
            - npm ci
            - npm --workspace packages/core run build
            - npm run dev:cli -- doctor

          Actions ë¡œê·¸ë¥¼ í™•ì¸í•˜ê³ , ìˆ˜ì • ì§€ì‹œë¥¼ ë‹¤ì‹œ `/ai ...` ë¡œ ë‚¨ê²¨ì£¼ì„¸ìš”."
          exit 1

      - name: Remove agent artifacts (if any)
        run: |
          set -euo pipefail
          rm -rf .gemini || true

      - name: Dry run - comment back and stop
        if: steps.ctx.outputs.dry_run == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          gh pr comment "${{ steps.pr.outputs.PR_NUMBER }}" --body \
            "ğŸ§ª DRY_RUN=true â€” ìˆ˜ì •/ê²€ì¦ê¹Œì§€ ì™„ë£Œí–ˆê³ , ì»¤ë°‹/í‘¸ì‹œëŠ” í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          exit 0

      - name: Commit & push (if changes exist)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          if git diff --quiet && git diff --cached --quiet; then
            echo "No changes to commit."
            gh pr comment "${{ steps.pr.outputs.PR_NUMBER }}" --body \
              "â„¹ï¸ ë³€ê²½ ì‚¬í•­ì´ ê°ì§€ë˜ì§€ ì•Šì•„ ì»¤ë°‹/í‘¸ì‹œí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            exit 0
          fi

          git config user.name "ai-bot"
          git config user.email "ai-bot@users.noreply.github.com"
          git add -A
          git commit -m "ai: follow-up from PR comment"
          git push

      - name: Comment back to PR (success)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          gh pr comment "${{ steps.pr.outputs.PR_NUMBER }}" --body \
            "âœ… /ai ì§€ì‹œì‚¬í•­ì„ ë°˜ì˜í•´ ì»¤ë°‹ì„ í‘¸ì‹œí–ˆìŠµë‹ˆë‹¤.

          - ë¸Œëœì¹˜: \`${{ steps.pr.outputs.HEAD_REF }}\`
          - PR: ${{ steps.pr.outputs.PR_URL }}

          ê²€ì¦:
          - npm ci
          - npm --workspace packages/core run build
          - npm run dev:cli -- doctor"
