name: AI PR Follow-up from Comment

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write

jobs:
  followup:
    # PR 코멘트이고 /ai 로 시작하며, 작성자가 너(kdm0324)일 때만 실행
    if: >
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/ai') &&
      github.actor == 'kdm0324'
    runs-on: ubuntu-latest

    steps:
      - name: Fetch PR metadata
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.issue.number }}"
          gh pr view "$PR_NUMBER" --json headRefName,headRepository,baseRepository,url \
            > pr.json

          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "HEAD_REF=$(jq -r '.headRefName' pr.json)" >> $GITHUB_OUTPUT
          echo "HEAD_REPO=$(jq -r '.headRepository.nameWithOwner' pr.json)" >> $GITHUB_OUTPUT
          echo "BASE_REPO=$(jq -r '.baseRepository.nameWithOwner' pr.json)" >> $GITHUB_OUTPUT
          echo "PR_URL=$(jq -r '.url' pr.json)" >> $GITHUB_OUTPUT

      - name: Safety gate (same repo + ai/* branch only)
        run: |
          if [ "${{ steps.pr.outputs.HEAD_REPO }}" != "${{ steps.pr.outputs.BASE_REPO }}" ]; then
            echo "Blocked: PR from a fork."
            exit 1
          fi
          case "${{ steps.pr.outputs.HEAD_REF }}" in
            ai/*) echo "OK: ai branch" ;;
            *) echo "Blocked: not an ai/* branch"; exit 1 ;;
          esac

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr.outputs.HEAD_REF }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps & build core
        run: |
          npm i
          npm --workspace packages/core run build

      - name: Install Codex CLI
        run: npm i -g @openai/codex

      - name: Run Codex follow-up
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMMENT_BODY="${{ github.event.comment.body }}"

          codex exec "
          You are continuing work on an existing AI-generated PR in cloud-native-devkit.

          PR COMMENT (natural language):
          ${COMMENT_BODY}

          REQUIRED BEHAVIOR:
          1) Internally convert the comment into a TOON plan (Task/Outcome/Ops/Notes). Do NOT ask the user.
          2) Apply ONLY what is requested. Keep changes minimal.
          3) Do not print secrets or env vars.
          4) Run exactly these verification commands:
             - npm i
             - npm --workspace packages/core run build
             - npm run dev:cli -- doctor
          5) If verification fails: STOP. Do NOT push. Instead, comment on the PR with failure + next steps.
          6) If verification passes: commit and push to the current branch.

          Proceed now.
          "

      - name: Commit & push (if changes exist)
        run: |
          if git diff --quiet && git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "ai-bot"
          git config user.email "ai-bot@users.noreply.github.com"
          git add -A
          git commit -m "ai: follow-up from PR comment"
          git push

      - name: Comment back to PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment "${{ steps.pr.outputs.PR_NUMBER }}" --body \
            "✅ Applied your /ai feedback and pushed commits to \`${{ steps.pr.outputs.HEAD_REF }}\`."
