name: AI Issue -> PR (Codex)

on:
  schedule:
    - cron: "10 12 * * *" # UTC 12:10 = KST 21:10
  workflow_dispatch:
    inputs:
      issue_number:
        description: "ì²˜ë¦¬í•  Issue ë²ˆí˜¸ (ë¹„ìš°ë©´ ai:task ì¤‘ 1ê°œ ìë™ ì„ íƒ)"
        required: false
        type: string
      dry_run:
        description: "trueë©´ PR ìƒì„±/í‘¸ì‹œ ì—†ì´ ê³„íš+ê²€ì¦ë§Œ ìˆ˜í–‰(ê°€ëŠ¥í•œ ë²”ìœ„)"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

permissions:
  contents: write
  pull-requests: write
  issues: write # gh issue comment í•˜ë ¤ë©´ write í•„ìš”

jobs:
  issue_to_pr:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps & build core
        run: |
          npm i
          npm --workspace packages/core run build

      - name: Pick issue (manual input or oldest ai:task)
        id: pick
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          INPUT_ISSUE="${{ inputs.issue_number }}"

          if [ -n "$INPUT_ISSUE" ]; then
            ISSUE_JSON=$(gh issue view "$INPUT_ISSUE" --json number,title,body,createdAt,state)
            ISSUE_STATE=$(echo "$ISSUE_JSON" | jq -r '.state')
            if [ "$ISSUE_STATE" != "OPEN" ]; then
              echo "Issue #$INPUT_ISSUE is not open. Exiting."
              echo "found=false" >> $GITHUB_OUTPUT
              exit 0
            fi

            echo "found=true" >> $GITHUB_OUTPUT
            echo "issue_number=$(echo "$ISSUE_JSON" | jq -r '.number')" >> $GITHUB_OUTPUT
            echo "issue_title=$(echo "$ISSUE_JSON" | jq -r '.title')" >> $GITHUB_OUTPUT
            echo "$ISSUE_JSON" | jq -r '.body // ""' > ISSUE_BODY.txt
            exit 0
          fi

          ISSUE_LIST=$(gh issue list --label "ai:task" --state open --limit 1 --json number,title,body,createdAt)
          ISSUE_NUMBER=$(echo "$ISSUE_LIST" | jq -r '.[0].number // empty')

          if [ -z "$ISSUE_NUMBER" ]; then
            echo "No ai:task issue found. Exiting."
            echo "found=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "found=true" >> $GITHUB_OUTPUT
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "issue_title=$(echo "$ISSUE_LIST" | jq -r '.[0].title')" >> $GITHUB_OUTPUT
          echo "$ISSUE_LIST" | jq -r '.[0].body // ""' > ISSUE_BODY.txt

      - name: Install Codex CLI
        if: steps.pick.outputs.found == 'true'
        run: npm i -g @openai/codex

      - name: Create branch, implement, test, and open PR
        if: steps.pick.outputs.found == 'true'
        env:
          # âœ… Codex CLIê°€ ì½ëŠ” í‚¤ ì´ë¦„
          CODEX_API_KEY: ${{ secrets.CODEX_API_KEY }}

          # (ì„ íƒ) ë‹¤ë¥¸ ìŠ¤í¬ë¦½íŠ¸/ë„êµ¬ í˜¸í™˜ìš©ìœ¼ë¡œ ê°™ì´ ë‘ê³  ì‹¶ìœ¼ë©´
          OPENAI_API_KEY: ${{ secrets.CODEX_API_KEY }}

          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER="${{ steps.pick.outputs.issue_number }}"
          ISSUE_TITLE="${{ steps.pick.outputs.issue_title }}"
          ISSUE_BODY="$(cat ISSUE_BODY.txt)"
          DRY_RUN="${{ inputs.dry_run }}"

          SHORT=$(echo "$ISSUE_TITLE" | tr '[:upper:]' '[:lower:]' | tr -cd 'a-z0-9 -' | tr ' ' '-' | cut -c1-24)
          BRANCH="ai/${ISSUE_NUMBER}-${SHORT}"

          git checkout -b "$BRANCH"

          codex exec "
          You are an autonomous coding agent working on the repository cloud-native-devkit.

          USER INPUT (natural language issue):
          Title: ${ISSUE_TITLE}
          Body:
          ${ISSUE_BODY}

          REQUIRED BEHAVIOR:
          1) Internally convert the user input into a TOON plan (Task/Outcome/Ops/Notes). Do NOT ask the user.
          2) ONLY implement what is in that plan. No extra features.
          3) Keep the change minimal and safe.
          4) Do not print secrets or environment variables.
          5) After changes, run exactly these verification commands:
             - npm i
             - npm --workspace packages/core run build
             - npm run dev:cli -- doctor
          6) If verification fails: STOP. Do NOT commit or push. Instead, explain failure and likely fix in a GitHub issue comment.
          7) If verification passes:
             - If DRY_RUN is true: do NOT commit/push/PR. Instead comment on the issue with the plan + what would change.
             - Else: commit, push, and open a PR.

          DRY_RUN=${DRY_RUN}
          IMPLEMENT NOW.
          "

          if [ "$DRY_RUN" = "true" ]; then
            gh issue comment "$ISSUE_NUMBER" --body "ğŸ§ª DRY_RUN=true â€” ì‘ì—… ê³„íšì„ ìˆ˜ë¦½/ê²€ì¦í–ˆê³ , ì»¤ë°‹/PRì€ ìƒì„±í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            exit 0
          fi

          if git diff --quiet && git diff --cached --quiet; then
            echo "No changes detected. Exiting."
            exit 0
          fi

          git config user.name "ai-bot"
          git config user.email "ai-bot@users.noreply.github.com"
          git add -A
          git commit -m "ai: ${ISSUE_NUMBER} ${ISSUE_TITLE}"
          git push --set-upstream origin "$BRANCH"

          gh pr create \
            --base main \
            --head "$BRANCH" \
            --title "AI: #${ISSUE_NUMBER} ${ISSUE_TITLE}" \
            --body "This PR was generated from issue #${ISSUE_NUMBER}.\n\nLeave a comment starting with \`/ai\` to request follow-ups.\n\nVerification:\n- npm i\n- npm --workspace packages/core run build\n- npm run dev:cli -- doctor\n"

          PR_URL=$(gh pr view --json url -q .url)
          gh issue comment "$ISSUE_NUMBER" --body "âœ… Opened PR: $PR_URL"
