name: AI Issue -> PR (Codex -> Gemini fallback)

on:
  schedule:
    - cron: "10 12 * * *" # UTC 12:10 = KST 21:10
  workflow_dispatch:
    inputs:
      issue_number:
        description: "ì²˜ë¦¬í•  Issue ë²ˆí˜¸ (ë¹„ìš°ë©´ ai:task ì¤‘ 1ê°œ ìë™ ì„ íƒ)"
        required: false
        type: string
      dry_run:
        description: "trueë©´ PR ìƒì„±/í‘¸ì‹œ ì—†ì´ ê³„íš+ê²€ì¦ë§Œ ìˆ˜í–‰"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: ai-issue-to-pr
  cancel-in-progress: false

jobs:
  issue_to_pr:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps & build core (baseline)
        run: |
          set -euo pipefail
          npm i
          npm --workspace packages/core run build

      - name: Pick issue (manual input or oldest ai:task)
        id: pick
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          INPUT_ISSUE="${{ inputs.issue_number }}"

          if [ -n "${INPUT_ISSUE:-}" ]; then
            ISSUE_JSON=$(gh issue view "$INPUT_ISSUE" --json number,title,body,createdAt,state,labels)
            ISSUE_STATE=$(echo "$ISSUE_JSON" | jq -r '.state')

            if [ "$ISSUE_STATE" != "OPEN" ]; then
              echo "Issue #$INPUT_ISSUE is not open. Exiting."
              echo "found=false" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            ISSUE_NUMBER=$(echo "$ISSUE_JSON" | jq -r '.number')

            # ì´ë¯¸ PRì´ ì—´ë ¤ìˆìœ¼ë©´ ìŠ¤í‚µ
            PR_COUNT=$(gh pr list --state open --search "linked:issue:$ISSUE_NUMBER" --json number | jq 'length')
            if [ "$PR_COUNT" -gt 0 ]; then
              echo "Issue #$ISSUE_NUMBER already has an open PR. Exiting."
              echo "found=false" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            echo "found=true" >> "$GITHUB_OUTPUT"
            echo "issue_number=$ISSUE_NUMBER" >> "$GITHUB_OUTPUT"
            echo "issue_title=$(echo "$ISSUE_JSON" | jq -r '.title')" >> "$GITHUB_OUTPUT"
            echo "$ISSUE_JSON" | jq -r '.body // ""' > ISSUE_BODY.txt
            exit 0
          fi

          # ai:task open ì „ì²´ë¥¼ ê°€ì ¸ì™€ì„œ createdAt ê¸°ì¤€ ì˜¤ë¦„ì°¨ìˆœ(=ê°€ì¥ ì˜¤ë˜ëœ ê²ƒ)ìœ¼ë¡œ 1ê°œ ì„ íƒ
          ISSUE_LIST=$(gh issue list --label "ai:task" --state open --limit 50 --json number,title,body,createdAt)
          ISSUE_NUMBER=$(
            echo "$ISSUE_LIST" \
            | jq -r 'sort_by(.createdAt) | .[0].number // empty'
          )

          if [ -z "${ISSUE_NUMBER:-}" ]; then
            echo "No ai:task issue found. Exiting."
            echo "found=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          ISSUE_JSON=$(echo "$ISSUE_LIST" | jq -c 'sort_by(.createdAt) | .[0]')
          ISSUE_TITLE=$(echo "$ISSUE_JSON" | jq -r '.title')
          echo "$ISSUE_JSON" | jq -r '.body // ""' > ISSUE_BODY.txt

          # ì´ë¯¸ PRì´ ì—´ë ¤ìˆìœ¼ë©´ ìŠ¤í‚µ (ì¬ì‹¤í–‰/ì¤‘ë³µ ë°©ì§€)
          PR_COUNT=$(gh pr list --state open --search "linked:issue:$ISSUE_NUMBER" --json number | jq 'length')
          if [ "$PR_COUNT" -gt 0 ]; then
            echo "Issue #$ISSUE_NUMBER already has an open PR. Exiting."
            echo "found=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "found=true" >> "$GITHUB_OUTPUT"
          echo "issue_number=$ISSUE_NUMBER" >> "$GITHUB_OUTPUT"
          echo "issue_title=$ISSUE_TITLE" >> "$GITHUB_OUTPUT"

      - name: Create branch (unique)
        if: steps.pick.outputs.found == 'true'
        run: |
          set -euo pipefail
          ISSUE_NUMBER="${{ steps.pick.outputs.issue_number }}"
          ISSUE_TITLE="${{ steps.pick.outputs.issue_title }}"
          SHORT=$(echo "$ISSUE_TITLE" | tr '[:upper:]' '[:lower:]' | tr -cd 'a-z0-9 -' | tr ' ' '-' | cut -c1-24)

          # âœ… í•­ìƒ ìœ ë‹ˆí¬í•˜ê²Œ ë§Œë“¤ì–´ì„œ push reject(fetch first) ë°©ì§€
          BRANCH="ai/${ISSUE_NUMBER}-${SHORT}-${{ github.run_id }}"

          echo "BRANCH=$BRANCH" >> "$GITHUB_ENV"
          git checkout -b "$BRANCH"

      # ----------------------------
      # Try Codex (best-effort)
      # ----------------------------
      - name: Install Codex CLI (best-effort)
        if: steps.pick.outputs.found == 'true'
        continue-on-error: true
        run: npm i -g @openai/codex

      - name: Agent (Codex best-effort)
        id: codex
        if: steps.pick.outputs.found == 'true'
        continue-on-error: true
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -euo pipefail
          ISSUE_TITLE="${{ steps.pick.outputs.issue_title }}"
          ISSUE_BODY="$(cat ISSUE_BODY.txt)"

          codex exec "
          You are an autonomous coding agent working on the repository cloud-native-devkit.

          USER INPUT (natural language issue):
          Title: ${ISSUE_TITLE}
          Body:
          ${ISSUE_BODY}

          REQUIRED BEHAVIOR:
          1) Internally convert the user input into a TOON plan (Task/Outcome/Ops/Notes). Do NOT ask the user.
          2) ONLY implement what is in that plan. No extra features.
          3) Keep the change minimal and safe.
          4) Do not print secrets or environment variables.
          5) Do NOT run verification commands yourself. The workflow will run:
             - npm i
             - npm --workspace packages/core run build
             - npm run dev:cli -- doctor
          IMPLEMENT NOW.
          "

      - name: Comment if Codex failed (fallback to Gemini)
        if: steps.pick.outputs.found == 'true' && steps.codex.outcome != 'success'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          ISSUE_NUMBER="${{ steps.pick.outputs.issue_number }}"
          gh issue comment "$ISSUE_NUMBER" --body "âš ï¸ Codexê°€ ì‹¤íŒ¨(í‚¤ ì—†ìŒ/Quota/ê¸°íƒ€)í•˜ì—¬ Geminië¡œ fallback í•©ë‹ˆë‹¤."

      # ----------------------------
      # Fallback to Gemini
      # - Geminiê°€ npm ê°™ì€ ì»¤ë§¨ë“œë¥¼ ì‹¤í–‰í•˜ì§€ ì•Šê²Œ ì§€ì‹œ
      # - í•˜ì§€ë§Œ ì‹¤ì œ ê²€ì¦(npm i/build/doctor)ì€ ì•„ë˜ Verify ìŠ¤í…ì—ì„œ VMì´ ìˆ˜í–‰
      # ----------------------------
      - name: Agent (Gemini fallback)
        if: steps.pick.outputs.found == 'true' && steps.codex.outcome != 'success'
        uses: google-github-actions/run-gemini-cli@v0
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          args: >-
            You are an autonomous coding agent working on the repository cloud-native-devkit.

            USER INPUT (natural language issue):
            Title: ${{ steps.pick.outputs.issue_title }}
            Body:
            $(cat ISSUE_BODY.txt)

            REQUIRED BEHAVIOR:
            - You MUST NOT run any install/build/test commands (npm, yarn, pnpm, make, gradle, mvn, etc).
            - You MUST NOT run any shell commands at all.
            - Only edit files to implement the requested change with minimal diff.
            - Do not print secrets or environment variables.
            IMPLEMENT NOW.

      # ----------------------------
      # Verify (runbook) - runner VMì—ì„œ ìˆ˜í–‰
      # ----------------------------
      - name: Verify (runbook)
        if: steps.pick.outputs.found == 'true'
        run: |
          set -euo pipefail
          npm i
          npm --workspace packages/core run build
          npm run dev:cli -- doctor

      - name: On verification failure, comment and stop
        if: failure() && steps.pick.outputs.found == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          ISSUE_NUMBER="${{ steps.pick.outputs.issue_number }}"
          gh issue comment "$ISSUE_NUMBER" --body "âŒ ê²€ì¦ ì»¤ë§¨ë“œì—ì„œ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì»¤ë°‹/í‘¸ì‹œ/PR ì—†ì´ ì¢…ë£Œí•©ë‹ˆë‹¤. Actions ë¡œê·¸ë¥¼ í™•ì¸í•˜ê³  ìˆ˜ì • í›„ ì¬ì‹¤í–‰í•´ì£¼ì„¸ìš”."
          exit 1

      # ----------------------------
      # DRY RUN or PR
      # ----------------------------
      - name: Dry run comment
        if: steps.pick.outputs.found == 'true' && inputs.dry_run == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          ISSUE_NUMBER="${{ steps.pick.outputs.issue_number }}"
          gh issue comment "$ISSUE_NUMBER" --body "ğŸ§ª DRY_RUN=true â€” ë³€ê²½/ê²€ì¦ê¹Œì§€ ì™„ë£Œí–ˆê³ , ì»¤ë°‹/PRì€ ìƒì„±í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          exit 0

      - name: Commit, push, open PR
        if: steps.pick.outputs.found == 'true' && inputs.dry_run != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          ISSUE_NUMBER="${{ steps.pick.outputs.issue_number }}"
          ISSUE_TITLE="${{ steps.pick.outputs.issue_title }}"

          if git diff --quiet && git diff --cached --quiet; then
            echo "No changes detected. Exiting."
            gh issue comment "$ISSUE_NUMBER" --body "â„¹ï¸ ë³€ê²½ ì‚¬í•­ì´ ì—†ì–´ PRì„ ë§Œë“¤ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            exit 0
          fi

          git config user.name "ai-bot"
          git config user.email "ai-bot@users.noreply.github.com"
          git add -A
          git commit -m "ai: ${ISSUE_NUMBER} ${ISSUE_TITLE}"
          git push --set-upstream origin "$BRANCH"

          gh pr create \
            --base main \
            --head "$BRANCH" \
            --title "AI: #${ISSUE_NUMBER} ${ISSUE_TITLE}" \
            --body "This PR was generated from issue #${ISSUE_NUMBER}.

            Verification:
            - npm i
            - npm --workspace packages/core run build
            - npm run dev:cli -- doctor
            "

          PR_URL=$(gh pr view --json url -q .url)
          gh issue comment "$ISSUE_NUMBER" --body "âœ… Opened PR: $PR_URL"

      # ----------------------------
      # Housekeeping (A: ë¼ë²¨ë§Œ ì œê±°)
      # - PR ì˜¤í”ˆ ì„±ê³µ í›„ ai:task ë¼ë²¨ ì œê±°í•´ì„œ ë‹¤ìŒ ìŠ¤ì¼€ì¤„ì—ì„œ ì¬ì²˜ë¦¬ ë°©ì§€
      # ----------------------------
      - name: Post-PR housekeeping (remove ai:task label)
        if: steps.pick.outputs.found == 'true' && inputs.dry_run != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          ISSUE_NUMBER="${{ steps.pick.outputs.issue_number }}"
          gh issue edit "$ISSUE_NUMBER" --remove-label "ai:task"
