name: AI Issue -> PR (Codex w/ Gemini fallback)

on:
  schedule:
    - cron: "10 12 * * *" # UTC 12:10 = KST 21:10
  workflow_dispatch:
    inputs:
      issue_number:
        description: "ì²˜ë¦¬í•  Issue ë²ˆí˜¸ (ë¹„ìš°ë©´ ai:task ì¤‘ 1ê°œ ìë™ ì„ íƒ)"
        required: false
        type: string
      dry_run:
        description: "trueë©´ PR ìƒì„±/í‘¸ì‹œ ì—†ì´ ê³„íš+ê²€ì¦ë§Œ ìˆ˜í–‰"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  issue_to_pr:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps & build core (baseline)
        run: |
          npm i
          npm --workspace packages/core run build

      - name: Pick issue (manual input or oldest ai:task)
        id: pick
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          INPUT_ISSUE="${{ inputs.issue_number }}"

          if [ -n "$INPUT_ISSUE" ]; then
            ISSUE_JSON=$(gh issue view "$INPUT_ISSUE" --json number,title,body,createdAt,state)
            ISSUE_STATE=$(echo "$ISSUE_JSON" | jq -r '.state')
            if [ "$ISSUE_STATE" != "OPEN" ]; then
              echo "Issue #$INPUT_ISSUE is not open. Exiting."
              echo "found=false" >> $GITHUB_OUTPUT
              exit 0
            fi

            echo "found=true" >> $GITHUB_OUTPUT
            echo "issue_number=$(echo "$ISSUE_JSON" | jq -r '.number')" >> $GITHUB_OUTPUT
            echo "issue_title=$(echo "$ISSUE_JSON" | jq -r '.title')" >> $GITHUB_OUTPUT
            echo "$ISSUE_JSON" | jq -r '.body // ""' > ISSUE_BODY.txt
            exit 0
          fi

          ISSUE_LIST=$(gh issue list --label "ai:task" --state open --limit 1 --json number,title,body,createdAt)
          ISSUE_NUMBER=$(echo "$ISSUE_LIST" | jq -r '.[0].number // empty')
          if [ -z "$ISSUE_NUMBER" ]; then
            echo "No ai:task issue found. Exiting."
            echo "found=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "found=true" >> $GITHUB_OUTPUT
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "issue_title=$(echo "$ISSUE_LIST" | jq -r '.[0].title')" >> $GITHUB_OUTPUT
          echo "$ISSUE_LIST" | jq -r '.[0].body // ""' > ISSUE_BODY.txt

      - name: Create branch
        if: steps.pick.outputs.found == 'true'
        run: |
          ISSUE_NUMBER="${{ steps.pick.outputs.issue_number }}"
          ISSUE_TITLE="${{ steps.pick.outputs.issue_title }}"
          SHORT=$(echo "$ISSUE_TITLE" | tr '[:upper:]' '[:lower:]' | tr -cd 'a-z0-9 -' | tr ' ' '-' | cut -c1-24)
          BRANCH="ai/${ISSUE_NUMBER}-${SHORT}"
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV
          git checkout -b "$BRANCH"

      # ----------------------------
      # 1) Try Codex (if key exists)
      # ----------------------------
      - name: Install Codex CLI
        if: steps.pick.outputs.found == 'true' && secrets.OPENAI_API_KEY != ''
        run: npm i -g @openai/codex

      - name: Agent (Codex)
        id: codex
        if: steps.pick.outputs.found == 'true' && secrets.OPENAI_API_KEY != ''
        continue-on-error: true
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          ISSUE_TITLE="${{ steps.pick.outputs.issue_title }}"
          ISSUE_BODY="$(cat ISSUE_BODY.txt)"

          set +e
          codex exec "
          You are an autonomous coding agent working on the repository cloud-native-devkit.

          USER INPUT (natural language issue):
          Title: ${ISSUE_TITLE}
          Body:
          ${ISSUE_BODY}

          REQUIRED BEHAVIOR:
          1) Internally convert the user input into a TOON plan (Task/Outcome/Ops/Notes). Do NOT ask the user.
          2) ONLY implement what is in that plan. No extra features.
          3) Keep the change minimal and safe.
          4) Do not print secrets or environment variables.
          5) Do NOT run verification commands yourself. The workflow will run:
             - npm i
             - npm --workspace packages/core run build
             - npm run dev:cli -- doctor
          IMPLEMENT NOW.
          "
          CODEX_STATUS=$?
          set -e

          echo "status=$CODEX_STATUS" >> $GITHUB_OUTPUT

      - name: If Codex failed, comment reason (quota/billing hint)
        if: steps.pick.outputs.found == 'true' && steps.codex.outputs.status != '' && steps.codex.outputs.status != '0'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER="${{ steps.pick.outputs.issue_number }}"
          gh issue comment "$ISSUE_NUMBER" --body "âš ï¸ Codex ì‹¤í–‰ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤(ì˜ˆ: quota/billing). Geminië¡œ fallbackì„ ì‹œë„í•©ë‹ˆë‹¤."

      # ----------------------------
      # 2) Fallback to Gemini
      # ----------------------------
      - name: Agent (Gemini fallback)
        if: steps.pick.outputs.found == 'true' && (steps.codex.outcome != 'success')
        uses: google-github-actions/run-gemini-cli@v0
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          prompt: |
            You are an autonomous coding agent working on the repository cloud-native-devkit.

            USER INPUT (natural language issue):
            Title: ${{ steps.pick.outputs.issue_title }}
            Body:
            $(cat ISSUE_BODY.txt)

            REQUIRED BEHAVIOR:
            1) Internally convert the user input into a TOON plan (Task/Outcome/Ops/Notes). Do NOT ask the user.
            2) ONLY implement what is in that plan. No extra features.
            3) Keep the change minimal and safe.
            4) Do not print secrets or environment variables.
            5) Do NOT run verification commands yourself. The workflow will run:
               - npm i
               - npm --workspace packages/core run build
               - npm run dev:cli -- doctor
            IMPLEMENT NOW.

      # ----------------------------
      # 3) Verify (Runbook commands)
      # ----------------------------
      - name: Verify (runbook)
        if: steps.pick.outputs.found == 'true'
        run: |
          npm i
          npm --workspace packages/core run build
          npm run dev:cli -- doctor

      - name: On verification failure, comment and stop
        if: failure() && steps.pick.outputs.found == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER="${{ steps.pick.outputs.issue_number }}"
          gh issue comment "$ISSUE_NUMBER" --body "âŒ ê²€ì¦ ì»¤ë§¨ë“œì—ì„œ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì»¤ë°‹/í‘¸ì‹œ/PR ì—†ì´ ì¢…ë£Œí•©ë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•˜ê³  ì›ì¸ì„ ìˆ˜ì •í•œ ë’¤ ì¬ì‹¤í–‰í•´ì£¼ì„¸ìš”."
          exit 1

      # ----------------------------
      # 4) DRY RUN or PR
      # ----------------------------
      - name: Dry run comment
        if: steps.pick.outputs.found == 'true' && inputs.dry_run == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER="${{ steps.pick.outputs.issue_number }}"
          gh issue comment "$ISSUE_NUMBER" --body "ğŸ§ª DRY_RUN=true â€” ë³€ê²½/ê²€ì¦ê¹Œì§€ ì™„ë£Œí–ˆê³ , ì»¤ë°‹/PRì€ ìƒì„±í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          exit 0

      - name: Commit, push, open PR
        if: steps.pick.outputs.found == 'true' && inputs.dry_run != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER="${{ steps.pick.outputs.issue_number }}"
          ISSUE_TITLE="${{ steps.pick.outputs.issue_title }}"

          if git diff --quiet && git diff --cached --quiet; then
            echo "No changes detected. Exiting."
            gh issue comment "$ISSUE_NUMBER" --body "â„¹ï¸ ë³€ê²½ ì‚¬í•­ì´ ì—†ì–´ PRì„ ë§Œë“¤ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            exit 0
          fi

          git config user.name "ai-bot"
          git config user.email "ai-bot@users.noreply.github.com"
          git add -A
          git commit -m "ai: ${ISSUE_NUMBER} ${ISSUE_TITLE}"
          git push --set-upstream origin "$BRANCH"

          gh pr create \
            --base main \
            --head "$BRANCH" \
            --title "AI: #${ISSUE_NUMBER} ${ISSUE_TITLE}" \
            --body "This PR was generated from issue #${ISSUE_NUMBER}.

            Verification:
            - npm i
            - npm --workspace packages/core run build
            - npm run dev:cli -- doctor
            "

          PR_URL=$(gh pr view --json url -q .url)
          gh issue comment "$ISSUE_NUMBER" --body "âœ… Opened PR: $PR_URL"
