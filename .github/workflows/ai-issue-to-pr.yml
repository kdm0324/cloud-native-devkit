name: AI Issue -> PR (Gemini only)

on:
  schedule:
    - cron: "10 12 * * *" # UTC 12:10 = KST 21:10
  workflow_dispatch:
    inputs:
      issue_number:
        description: "ì²˜ë¦¬í•  Issue ë²ˆí˜¸ (ë¹„ìš°ë©´ ai:task ì¤‘ 1ê°œ ìë™ ì„ íƒ)"
        required: false
        type: string
      dry_run:
        description: "trueë©´ PR ìƒì„±/í‘¸ì‹œ ì—†ì´ ê³„íš+ê²€ì¦ë§Œ ìˆ˜í–‰"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: ai-issue-to-pr
  cancel-in-progress: false

jobs:
  issue_to_pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps & build core (baseline)
        run: |
          set -euo pipefail
          npm ci
          npm --workspace packages/core run build

      - name: Pick issue (manual input or oldest ai:task)
        id: pick
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          INPUT_ISSUE="${{ inputs.issue_number }}"

          pick_issue_by_number() {
            local num="$1"

            local issue_json
            issue_json="$(gh issue view "$num" --json number,title,body,createdAt,state)"

            local state
            state="$(echo "$issue_json" | jq -r '.state')"
            if [ "$state" != "OPEN" ]; then
              echo "Issue #$num is not open. Exiting."
              echo "found=false" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            local issue_number
            issue_number="$(echo "$issue_json" | jq -r '.number')"

            # ì´ë¯¸ PRì´ ì—´ë ¤ìˆìœ¼ë©´ ìŠ¤í‚µ
            local pr_count
            pr_count="$(gh pr list --state open --search "linked:issue:$issue_number" --json number | jq 'length')"
            if [ "$pr_count" -gt 0 ]; then
              echo "Issue #$issue_number already has an open PR. Exiting."
              echo "found=false" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            local issue_title
            issue_title="$(echo "$issue_json" | jq -r '.title')"

            echo "$issue_json" | jq -r '.body // ""' > ISSUE_BODY.txt

            echo "found=true" >> "$GITHUB_OUTPUT"
            echo "issue_number=$issue_number" >> "$GITHUB_OUTPUT"

            # âœ… titleì€ multiline/íŠ¹ìˆ˜ë¬¸ì ì•ˆì „í•˜ê²Œ ì €ì¥
            {
              echo "issue_title<<__GHA_EOF__"
              echo "$issue_title"
              echo "__GHA_EOF__"
            } >> "$GITHUB_OUTPUT"
          }

          if [ -n "${INPUT_ISSUE:-}" ]; then
            pick_issue_by_number "$INPUT_ISSUE"
            exit 0
          fi

          ISSUE_LIST="$(gh issue list --label "ai:task" --state open --limit 50 --json number,title,body,createdAt)"

          ISSUE_NUMBER="$(
            echo "$ISSUE_LIST" | jq -r 'sort_by(.createdAt) | .[0].number // empty'
          )"

          if [ -z "${ISSUE_NUMBER:-}" ]; then
            echo "No ai:task issue found. Exiting."
            echo "found=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          pick_issue_by_number "$ISSUE_NUMBER"

      - name: Create branch (unique per run)
        if: steps.pick.outputs.found == 'true'
        run: |
          set -euo pipefail

          ISSUE_NUMBER="${{ steps.pick.outputs.issue_number }}"
          ISSUE_TITLE="${{ steps.pick.outputs.issue_title }}"

          SHORT="$(echo "$ISSUE_TITLE" \
            | tr '[:upper:]' '[:lower:]' \
            | tr -cd 'a-z0-9 -' \
            | tr ' ' '-' \
            | cut -c1-24)"

          BRANCH="ai/${ISSUE_NUMBER}-${SHORT}-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"
          echo "BRANCH=$BRANCH" >> "$GITHUB_ENV"

          git checkout -b "$BRANCH"

      - name: Install Gemini CLI
        if: steps.pick.outputs.found == 'true'
        run: |
          set -euo pipefail
          npm i -g @google/gemini-cli
          gemini --version

      - name: Agent (Gemini on runner - edit repo)
        if: steps.pick.outputs.found == 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          set -euo pipefail

          ISSUE_NUMBER="${{ steps.pick.outputs.issue_number }}"
          ISSUE_TITLE="${{ steps.pick.outputs.issue_title }}"
          ISSUE_BODY="$(cat ISSUE_BODY.txt)"

          # í”„ë¡¬í”„íŠ¸ë¥¼ íŒŒì¼ë¡œ ë§Œë“¤ì–´ ì „ë‹¬ (ë¬¸ìì—´ ì¹˜í™˜/ê°œí–‰ ë¬¸ì œ íšŒí”¼)
          cat > /tmp/prompt.txt <<'PROMPT'
          You are an autonomous coding agent running INSIDE a GitHub Actions runner.
          The repository is already checked out locally. You MUST edit local files directly.

          HARD RULES:
          - Implement ONLY what the issue asks.
          - Keep the diff minimal and safe.
          - Do NOT create any new files or folders (especially no .gemini/*, no scripts, no extra docs).
          - Do NOT modify package-lock.json or any dependency files.
          - Do NOT run any install/build/test commands (npm/yarn/pnpm/make/gradle/mvn/etc).
          - Do NOT print secrets or environment variables.

          Issue:
          - Number: __ISSUE_NUMBER__
          - Title: __ISSUE_TITLE__
          - Body:
          __ISSUE_BODY__

          Now implement by editing the repository files.
          PROMPT

          # placeholder ì¹˜í™˜
          sed -i "s|__ISSUE_NUMBER__|${ISSUE_NUMBER}|g" /tmp/prompt.txt
          sed -i "s|__ISSUE_TITLE__|${ISSUE_TITLE}|g" /tmp/prompt.txt
          perl -0777 -i -pe 's/__ISSUE_BODY__/$ENV{ISSUE_BODY}/g' /tmp/prompt.txt

          # Gemini ì‹¤í–‰
          gemini "$(cat /tmp/prompt.txt)"

          echo "---- git status (after gemini) ----"
          git status --porcelain

          # âœ… .gemini ê°™ì€ ë¶€ì‚°ë¬¼ ìƒê¸°ë©´ ì¦‰ì‹œ ì‹¤íŒ¨ (ì›ì¹˜ ì•ŠëŠ” ìƒì„±ë¬¼ ë°©ì§€)
          if [ -d ".gemini" ]; then
            echo "ERROR: .gemini directory was created. This is not allowed."
            exit 1
          fi

          # âœ… package-lock.json ë³€ê²½ ê¸ˆì§€
          if git diff --name-only | grep -q '^package-lock\.json$'; then
            echo "ERROR: package-lock.json was modified. This is not allowed."
            exit 1
          fi

      - name: Verify (runbook)
        if: steps.pick.outputs.found == 'true'
        run: |
          set -euo pipefail
          npm ci
          npm --workspace packages/core run build
          npm run dev:cli -- doctor

      - name: On verification failure, comment and stop
        if: failure() && steps.pick.outputs.found == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          ISSUE_NUMBER="${{ steps.pick.outputs.issue_number }}"
          gh issue comment "$ISSUE_NUMBER" --body "âŒ ê²€ì¦ ì»¤ë§¨ë“œì—ì„œ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì»¤ë°‹/í‘¸ì‹œ/PR ì—†ì´ ì¢…ë£Œí•©ë‹ˆë‹¤. Actions ë¡œê·¸ë¥¼ í™•ì¸í•˜ê³  ìˆ˜ì • í›„ ì¬ì‹¤í–‰í•´ì£¼ì„¸ìš”."
          exit 1

      - name: Dry run comment
        if: steps.pick.outputs.found == 'true' && inputs.dry_run == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          ISSUE_NUMBER="${{ steps.pick.outputs.issue_number }}"
          gh issue comment "$ISSUE_NUMBER" --body "ğŸ§ª DRY_RUN=true â€” ë³€ê²½/ê²€ì¦ê¹Œì§€ ì™„ë£Œí–ˆê³ , ì»¤ë°‹/PRì€ ìƒì„±í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          exit 0

      - name: Commit, push, open PR
        if: steps.pick.outputs.found == 'true' && inputs.dry_run != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          ISSUE_NUMBER="${{ steps.pick.outputs.issue_number }}"
          ISSUE_TITLE="${{ steps.pick.outputs.issue_title }}"

          # ì›Œí¬í”Œë¡œ íŒŒì¼ ì œê±° (ì»¤ë°‹ì— ì„ì´ì§€ ì•Šê²Œ)
          rm -f ISSUE_BODY.txt || true

          if git diff --quiet && git diff --cached --quiet; then
            echo "No changes detected. Exiting."
            gh issue comment "$ISSUE_NUMBER" --body "â„¹ï¸ ë³€ê²½ ì‚¬í•­ì´ ì—†ì–´ PRì„ ë§Œë“¤ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            exit 0
          fi

          git config user.name "ai-bot"
          git config user.email "ai-bot@users.noreply.github.com"

          git add -A
          git commit -m "ai: ${ISSUE_NUMBER} ${ISSUE_TITLE}"

          git push --set-upstream origin "$BRANCH"

          gh pr create \
            --base main \
            --head "$BRANCH" \
            --title "AI: #${ISSUE_NUMBER} ${ISSUE_TITLE}" \
            --body "Fixes #${ISSUE_NUMBER}

          This PR was generated from issue #${ISSUE_NUMBER}.

          Verification:
          - npm ci
          - npm --workspace packages/core run build
          - npm run dev:cli -- doctor
          "

          PR_URL="$(gh pr view --json url -q .url)"
          gh issue comment "$ISSUE_NUMBER" --body "âœ… Opened PR: $PR_URL"

      - name: Post-PR housekeeping (remove ai:task label)
        if: steps.pick.outputs.found == 'true' && inputs.dry_run != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          ISSUE_NUMBER="${{ steps.pick.outputs.issue_number }}"
          gh issue edit "$ISSUE_NUMBER" --remove-label "ai:task"
