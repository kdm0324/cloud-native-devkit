name: AI Issue -> PR (Gemini)

on:
  schedule:
    - cron: "10 12 * * *" # UTC 12:10 = KST 21:10
  workflow_dispatch:
    inputs:
      issue_number:
        description: "ì²˜ë¦¬í•  Issue ë²ˆí˜¸ (ë¹„ìš°ë©´ ai:task ì¤‘ 1ê°œ ìë™ ì„ íƒ)"
        required: false
        type: string
      dry_run:
        description: "trueë©´ PR ìƒì„±/í‘¸ì‹œ ì—†ì´ ê³„íš+ê²€ì¦ë§Œ ìˆ˜í–‰"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: ai-issue-to-pr
  cancel-in-progress: false

jobs:
  issue_to_pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Baseline install/build (optional fast fail)
        run: |
          set -euo pipefail
          npm ci
          npm --workspace packages/core run build

      - name: Pick issue (manual input or oldest ai:task)
        id: pick
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          INPUT_ISSUE="${{ inputs.issue_number }}"
          BODY_FILE="${RUNNER_TEMP}/ISSUE_BODY.txt"

          pick_issue_by_number() {
            local num="$1"

            ISSUE_JSON="$(gh issue view "$num" --json number,title,body,createdAt,state)"
            ISSUE_STATE="$(echo "$ISSUE_JSON" | jq -r '.state')"

            if [ "$ISSUE_STATE" != "OPEN" ]; then
              echo "Issue #$num is not open."
              echo "found=false" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            ISSUE_NUMBER="$(echo "$ISSUE_JSON" | jq -r '.number')"
            ISSUE_TITLE="$(echo "$ISSUE_JSON" | jq -r '.title')"
            echo "$ISSUE_JSON" | jq -r '.body // ""' > "$BODY_FILE"

            # ì´ë¯¸ PRì´ ì—´ë ¤ìˆìœ¼ë©´ ìŠ¤í‚µ (ì¬ì‹¤í–‰/ì¤‘ë³µ ë°©ì§€)
            PR_COUNT="$(gh pr list --state open --search "linked:issue:$ISSUE_NUMBER" --json number | jq 'length')"
            if [ "$PR_COUNT" -gt 0 ]; then
              echo "Issue #$ISSUE_NUMBER already has an open PR."
              echo "found=false" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            echo "found=true" >> "$GITHUB_OUTPUT"
            echo "issue_number=$ISSUE_NUMBER" >> "$GITHUB_OUTPUT"

            # ë©€í‹°ë¼ì¸ ì•ˆì „ ì¶œë ¥ (quoted delimiter ì‚¬ìš© ê¸ˆì§€)
            {
              echo "issue_title<<EOF"
              echo "$ISSUE_TITLE"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"

            echo "body_file=$BODY_FILE" >> "$GITHUB_OUTPUT"
          }

          if [ -n "${INPUT_ISSUE:-}" ]; then
            pick_issue_by_number "$INPUT_ISSUE"
            exit 0
          fi

          ISSUE_LIST="$(gh issue list --label "ai:task" --state open --limit 50 --json number,title,body,createdAt)"
          ISSUE_NUMBER="$(echo "$ISSUE_LIST" | jq -r 'sort_by(.createdAt) | .[0].number // empty')"

          if [ -z "${ISSUE_NUMBER:-}" ]; then
            echo "No ai:task issue found."
            echo "found=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          pick_issue_by_number "$ISSUE_NUMBER"

      - name: Create branch (unique per run)
        if: steps.pick.outputs.found == 'true'
        run: |
          set -euo pipefail

          ISSUE_NUMBER="${{ steps.pick.outputs.issue_number }}"
          ISSUE_TITLE="${{ steps.pick.outputs.issue_title }}"

          SHORT="$(echo "$ISSUE_TITLE" \
            | tr '[:upper:]' '[:lower:]' \
            | tr -cd 'a-z0-9 -' \
            | tr ' ' '-' \
            | cut -c1-24)"

          BRANCH="ai/${ISSUE_NUMBER}-${SHORT}-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"
          echo "BRANCH=$BRANCH" >> "$GITHUB_ENV"

          git checkout -b "$BRANCH"

      - name: Prevent committing Gemini artifacts (local exclude)
        if: steps.pick.outputs.found == 'true'
        run: |
          set -euo pipefail
          {
            echo ".gemini/"
            echo "ISSUE_BODY.txt"
            echo "*.gemini*"
          } >> .git/info/exclude

      - name: Install Gemini CLI
        if: steps.pick.outputs.found == 'true'
        run: |
          set -euo pipefail
          npm i -g @google/gemini-cli

      - name: Agent (Gemini edits repo in VM)
        if: steps.pick.outputs.found == 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          set -euo pipefail

          ISSUE_NUMBER="${{ steps.pick.outputs.issue_number }}"
          ISSUE_TITLE="${{ steps.pick.outputs.issue_title }}"
          BODY_FILE="${{ steps.pick.outputs.body_file }}"

          PROMPT_FILE="${RUNNER_TEMP}/PROMPT.txt"

          cat > "$PROMPT_FILE" <<EOF
          You are an autonomous coding agent working inside a GitHub Actions runner.
          
          Repository: cloud-native-devkit
          You can see the checked-out source code on disk and may edit files.
          
          Issue:
          - Number: #${ISSUE_NUMBER}
          - Title: ${ISSUE_TITLE}
          - Body:
          $(cat "$BODY_FILE")
          
          Rules (MUST follow):
          1) Implement ONLY what the issue asks. Keep diff minimal.
          2) Prefer editing existing files; do NOT create new config/command files (especially under .gemini/).
          3) Do NOT run install/build/test commands yourself (npm/yarn/pnpm/make/gradle/mvn etc). The workflow will run verification after you finish.
          4) Do NOT print secrets or environment variables.
          5) If the issue is "docs only", change docs only.
          
          Now modify the repository files accordingly.
          EOF

          # ê°„ë‹¨ ì¬ì‹œë„ (429 ë“± ìˆœê°„ ì˜¤ë¥˜ ëŒ€ì‘). ì¼ì¼ quota ì†Œì§„ì´ë©´ ê²°êµ­ ì‹¤íŒ¨í•  ìˆ˜ ìˆìŒ.
          attempts=0
          max_attempts=3

          while true; do
            attempts=$((attempts+1))
            echo "Gemini attempt ${attempts}/${max_attempts}"

            set +e
            gemini --yolo "$(cat "$PROMPT_FILE")" 2> "${RUNNER_TEMP}/gemini_stderr.txt"
            rc=$?
            set -e

            if [ $rc -eq 0 ]; then
              echo "Gemini completed."
              break
            fi

            if grep -qiE "quota|429|Too Many|rate limit" "${RUNNER_TEMP}/gemini_stderr.txt"; then
              echo "Gemini quota/rate-limit detected."
            fi

            if [ $attempts -ge $max_attempts ]; then
              echo "Gemini failed after retries."
              cat "${RUNNER_TEMP}/gemini_stderr.txt" || true
              exit 1
            fi

            sleep $((attempts * 10))
          done

          # ë¶€ì‚°ë¬¼ ë°©ì§€(í˜¹ì‹œ ìƒì„±ë˜ë©´ ì»¤ë°‹ ì „ì— ì œê±°)
          rm -rf .gemini || true

      - name: Verify (runbook)
        if: steps.pick.outputs.found == 'true'
        run: |
          set -euo pipefail
          npm ci
          npm --workspace packages/core run build
          npm run dev:cli -- doctor

      - name: On verification failure, comment and stop
        if: failure() && steps.pick.outputs.found == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          ISSUE_NUMBER="${{ steps.pick.outputs.issue_number }}"
          gh issue comment "$ISSUE_NUMBER" --body "âŒ ê²€ì¦ ì»¤ë§¨ë“œ(npm ci/build/doctor)ì—ì„œ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì»¤ë°‹/í‘¸ì‹œ/PR ì—†ì´ ì¢…ë£Œí•©ë‹ˆë‹¤. Actions ë¡œê·¸ë¥¼ í™•ì¸í•˜ê³  ìˆ˜ì • í›„ ì¬ì‹¤í–‰í•´ì£¼ì„¸ìš”."
          exit 1

      - name: Dry run comment
        if: steps.pick.outputs.found == 'true' && inputs.dry_run == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          ISSUE_NUMBER="${{ steps.pick.outputs.issue_number }}"
          gh issue comment "$ISSUE_NUMBER" --body "ğŸ§ª DRY_RUN=true â€” ë³€ê²½/ê²€ì¦ê¹Œì§€ ì™„ë£Œí–ˆê³ , ì»¤ë°‹/PRì€ ìƒì„±í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          exit 0

      - name: Commit, push, open PR
        if: steps.pick.outputs.found == 'true' && inputs.dry_run != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          ISSUE_NUMBER="${{ steps.pick.outputs.issue_number }}"
          ISSUE_TITLE="${{ steps.pick.outputs.issue_title }}"

          # í˜¹ì‹œ ë‚¨ì•„ìˆìœ¼ë©´ ì œê±°
          rm -rf .gemini || true

          # ë³€ê²½ ì—†ìœ¼ë©´ ì¢…ë£Œ
          if git diff --quiet && git diff --cached --quiet; then
            echo "No changes detected."
            gh issue comment "$ISSUE_NUMBER" --body "â„¹ï¸ ë³€ê²½ ì‚¬í•­ì´ ì—†ì–´ PRì„ ë§Œë“¤ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            exit 0
          fi

          git config user.name "ai-bot"
          git config user.email "ai-bot@users.noreply.github.com"

          # ì»¤ë°‹ì—ì„œ ì œì™¸í•´ì•¼ í•  ê²ƒë“¤ì€ pathspecë¡œ í•œë²ˆ ë” ë°©ì–´
          git add -A -- ':!.gemini' ':!ISSUE_BODY.txt'

          # ê·¸ë˜ë„ stagedê°€ ì—†ìœ¼ë©´ ì¢…ë£Œ
          if git diff --cached --quiet; then
            echo "No staged changes."
            gh issue comment "$ISSUE_NUMBER" --body "â„¹ï¸ ìŠ¤í…Œì´ì§•ëœ ë³€ê²½ ì‚¬í•­ì´ ì—†ì–´ PRì„ ë§Œë“¤ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            exit 0
          fi

          git commit -m "ai: ${ISSUE_NUMBER} ${ISSUE_TITLE}"
          git push --set-upstream origin "$BRANCH"

          gh pr create \
            --base main \
            --head "$BRANCH" \
            --title "AI: #${ISSUE_NUMBER} ${ISSUE_TITLE}" \
            --body "Fixes #${ISSUE_NUMBER}

            This PR was generated from issue #${ISSUE_NUMBER}.
            
            Verification:
            - npm ci
            - npm --workspace packages/core run build
            - npm run dev:cli -- doctor
            "

          PR_URL="$(gh pr view --json url -q .url)"
          gh issue comment "$ISSUE_NUMBER" --body "âœ… Opened PR: $PR_URL"

      - name: Post-PR housekeeping (remove ai:task label)
        if: steps.pick.outputs.found == 'true' && inputs.dry_run != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          ISSUE_NUMBER="${{ steps.pick.outputs.issue_number }}"
          gh issue edit "$ISSUE_NUMBER" --remove-label "ai:task"
